<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ProSpect | Route Manager</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --brand-blue: #2b579a; --brand-red: #d93025; --gray: #f4f4f4; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout */
        #map { flex: 1; width: 100%; position: relative; }
        #sidebar { height: 45vh; background: white; border-top: 2px solid #ddd; display: flex; flex-direction: column; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 10; }
        
        /* Header & Controls */
        header { background: var(--brand-blue); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-group { display: flex; gap: 8px; padding: 10px; background: #eee; border-bottom: 1px solid #ddd; }
        button { padding: 8px 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .btn-opt { background: var(--brand-blue); color: white; }
        .btn-calc { background: #444; color: white; }
        
        /* Stop List */
        #stop-list { flex: 1; overflow-y: auto; }
        .stop-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: white; transition: 0.2s; }
        .stop-item.completed { opacity: 0.5; background: #fafafa; }
        .stop-item.cancelled { display: none; }
        .handle { color: #ccc; cursor: grab; padding: 0 10px; font-size: 18px; }
        .stop-info { flex: 1; }
        .stop-info b { font-size: 14px; display: block; }
        .stop-meta { font-size: 11px; color: #666; margin-top: 3px; }
        .warning { color: var(--brand-red); font-weight: bold; }
        
        /* Actions */
        .actions { display: flex; gap: 15px; padding-right: 10px; }
        .action-icon { font-size: 18px; cursor: pointer; }
        .check-icon { color: #28a745; }
        .trash-icon { color: var(--brand-red); }

        /* Map Popups */
        .mapboxgl-popup-content { font-size: 12px; padding: 15px; border-radius: 8px; }
        .nav-btn { display: block; margin-top: 10px; text-align: center; background: var(--brand-blue); color: white; padding: 5px; text-decoration: none; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <span><b>ProSpect</b> Route Manager</span>
    <span id="driver-label" style="font-size: 12px; opacity: 0.8;"></span>
</header>

<div id="map"></div>

<div id="sidebar">
    <div class="btn-group">
        <button class="btn-opt" onclick="processAction('optimize')"><i class="fa-solid fa-wand-magic-sparkles"></i> Re-Optimize</button>
        <button class="btn-calc" onclick="processAction('calculate')"><i class="fa-solid fa-calculator"></i> Re-Calculate</button>
    </div>
    <div id="stop-list"></div>
</div>

<script>
    // --- CONFIGURATION ---
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibXlwaWVpbnRlcmFjdGl2ZSIsImEiOiJjbWx1aWgybHIwYzNsM2dweXB1d2kxaTR4In0.PM8kROt0_QOOu-2mwmJ7mg';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx_1YmGxRQI3YNvBUiJnlAwkKg-REnGFSZbn8fyqeijjXXLN009g5ziIY8DNdtFA_4D/exec';
    
    mapboxgl.accessToken = MAPBOX_TOKEN;

    // --- DATA HANDLING ---
    const urlParams = new URLSearchParams(window.location.search);
    const driverName = urlParams.get('driver') || "Unknown Driver";
    document.getElementById('driver-label').innerText = driverName;

    let stops = []; // To be populated from Sheet on load
    let markers = [];

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-96.7970, 32.7767], // Default Dallas
        zoom: 10
    });

    // --- SIDEBAR & DRAG LOGIC ---
    const listEl = document.getElementById('stop-list');
    Sortable.create(listEl, {
        handle: '.handle',
        animation: 150,
        onEnd: () => { console.log("New order detected"); }
    });

    function renderList() {
        listEl.innerHTML = '';
        stops.forEach((stop, index) => {
            const item = document.createElement('div');
            item.className = `stop-item ${stop.status}`;
            item.setAttribute('data-id', stop.id);
            item.innerHTML = `
                <div class="handle"><i class="fa-solid fa-grip-lines"></i></div>
                <div class="stop-info">
                    <b>${index + 1}. ${stop.address.split(',')[0]}</b>
                    <div class="stop-meta">
                        <span>ETA: <span class="${stop.eta.includes('⚠️') ? 'warning' : ''}">${stop.eta}</span></span> | 
                        <span>Dist: ${stop.dist}</span><br>
                        <span>${stop.client} | ${stop.type}</span>
                    </div>
                </div>
                <div class="actions">
                    <i class="fa-solid fa-circle-check action-icon check-icon" onclick="toggleComplete('${stop.id}')"></i>
                    <i class="fa-solid fa-trash-can action-icon trash-icon" onclick="removeStop('${stop.id}')"></i>
                </div>
            `;
            listEl.appendChild(item);
        });
        updateMap();
    }

    function toggleComplete(id) {
        const stop = stops.find(s => s.id == id);
        stop.status = stop.status === 'completed' ? '' : 'completed';
        renderList();
    }

    function removeStop(id) {
        if(confirm("Cancel this stop?")) {
            const stop = stops.find(s => s.id == id);
            stop.status = 'cancelled';
            renderList();
        }
    }

    // --- API COMMUNICATION ---
    async function processAction(actionType) {
        const activeStops = Array.from(document.querySelectorAll('.stop-item')).map(el => {
            const id = el.getAttribute('data-id');
            return stops.find(s => s.id == id);
        });

        const btn = event.currentTarget;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...';

        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: actionType,
                    driver: driverName,
                    stops: activeStops
                })
            });
            const result = await response.json();
            stops = result.updatedStops;
            renderList();
        } catch (e) {
            alert("Error syncing with Google Sheets.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = actionType === 'optimize' ? 
                '<i class="fa-solid fa-wand-magic-sparkles"></i> Re-Optimize' : 
                '<i class="fa-solid fa-calculator"></i> Re-Calculate';
        }
    }

    function updateMap() {
        markers.forEach(m => m.remove());
        markers = [];
        
        const bounds = new mapboxgl.LngLatBounds();

        stops.filter(s => s.status !== 'cancelled').forEach((stop, i) => {
            const color = stop.status === 'completed' ? '#999' : '#d93025';
            
            const marker = new mapboxgl.Marker({ color: color })
                .setLngLat([stop.lng, stop.lat])
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <b>Stop ${i+1}</b><br>${stop.address}<br>
                    <a class="nav-btn" href="https://www.google.com/maps/dir/?api=1&destination=${stop.lat},${stop.lng}">Navigate</a>
                `))
                .addTo(map);
            
            markers.push(marker);
            bounds.extend([stop.lng, stop.lat]);
        });

        if (stops.length > 0) map.fitBounds(bounds, { padding: 50 });
    }

    // Initial Load - You would pass the initial data via URL or a fetch here
    // For demo purposes, we'll assume 'stops' is filled via a fetch on start
</script>

</body>
</html>
