<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ProSpect | Route Manager</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --blue: #2b579a; --red: #d93025; --green: #28a745; }
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: #fff; overflow: hidden; }
        
        /* Map Section */
        #map { flex: 1; width: 100%; position: relative; z-index: 1; border-bottom: 1px solid #ccc; }
        
        /* Sidebar Section */
        #sidebar { height: 55vh; display: flex; flex-direction: column; background: white; z-index: 10; position: relative; }
        
        /* Temporary Address Overrides */
        .address-overrides { padding: 10px; background: #f1f1f1; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 5px; }
        .address-overrides input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        /* Controls */
        #controls { display: none; padding: 12px; background: #fff; border-bottom: 1px solid #ddd; align-items: center; justify-content: center; gap: 10px; }
        .status-msg { color: var(--red); font-weight: bold; font-size: 13px; }
        .btn-action { padding: 10px 15px; border: none; border-radius: 4px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; }

        /* List UI */
        #stop-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .stop-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; transition: background 0.3s; position: relative; touch-action: pan-y; }
        .stop-item.completed { opacity: 0.5; background: #f9f9f9; }
        .stop-item.highlight { background: #fff9c4 !important; }
        
        .handle { padding: 10px 15px; color: #ccc; cursor: grab; font-size: 24px; }
        .stop-content { flex: 1; font-size: 14px; }
        .check-icon { font-size: 40px; color: var(--green); margin-left: 10px; cursor: pointer; padding: 5px; }
        
        /* Numbered Pins */
        .marker { width: 34px; height: 34px; background: var(--red); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 15px; }
        .marker.completed { background: #999; }

        /* Modals */
        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: none; }
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 2000; display:none; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="map"><div id="loader">Loading...</div></div>

<div id="sidebar">
    <div class="address-overrides">
        <input type="text" id="start-node" placeholder="Temporary Start Address" onchange="showControls()">
        <input type="text" id="end-node" placeholder="Temporary End Address" onchange="showControls()">
    </div>
    <div id="controls">
        <span class="status-msg">Changes made</span>
        <button class="btn-action" style="background:var(--blue)" onclick="triggerSync('optimize')">Re-Optimize</button>
        <button class="btn-action" style="background:#444" onclick="triggerSync('calculate')">Re-Calculate</button>
    </div>
    <div id="stop-list"></div>
</div>

<div id="modal-overlay">
    <div style="background:white; padding:25px; border-radius:12px; width:85%; max-width:320px; text-align:center;">
        <h3 id="modal-title">Confirm</h3>
        <p id="modal-body"></p>
        <div style="display:flex; gap:10px; margin-top:20px;" id="modal-btns"></div>
    </div>
</div>

<script>
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibXlwaWVpbnRlcmFjdGl2ZSIsImEiOiJjbWx2ajk5Z2MwOGZlM2VwcDBkc295dzI1In0.eGIhcRPrj_Hx_PeoFAYxBA';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwUcV6_7hBLb41N2M3aWEjbJtCGAb0Yeke8537P3ETml-RfMRV4msv_y6P5HctvuxqV/exec';
    
    const params = new URLSearchParams(window.location.search);
    const routeId = params.get('id');
    const driver = params.get('driver');

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-96.797, 32.776],
        zoom: 11
    });

    let stops = [];
    let markers = [];
    let currentDeleteId = null;

    async function loadData() {
        if (!routeId) return;
        showLoader("Loading...");
        try {
            const res = await fetch(`${WEB_APP_URL}?id=${routeId}`);
            stops = await res.json();
            render();
        } catch (e) { console.error(e); }
        showLoader(null);
    }

    function render() {
        const list = document.getElementById('stop-list');
        list.innerHTML = '';
        markers.forEach(m => m.remove());
        markers = [];
        const bounds = new mapboxgl.LngLatBounds();

        stops.filter(s => s.status !== 'cancelled').forEach((s, i) => {
            const item = document.createElement('div');
            item.className = `stop-item ${s.status}`;
            item.id = `item-${s.id}`;
            item.innerHTML = `
                <div class="handle">â˜°</div>
                <div class="stop-content" onclick="openNativeNav('${s.lat}','${s.lng}')">
                    <b style="font-size:16px;">${i + 1}. ${s.address.split(',')[0]}</b><br>
                    <small>${s.eta} | ${s.dist}</small><br>
                    <small style="color:#888;">${s.client}</small>
                </div>
                <i class="fa-solid fa-circle-check check-icon" onclick="completeStop('${s.id}')"></i>
            `;
            
            // Swipe Left to Delete
            let startX = 0;
            item.addEventListener('touchstart', (e) => startX = e.touches[0].clientX);
            item.addEventListener('touchend', (e) => {
                if (startX - e.changedTouches[0].clientX > 80) {
                    confirmDelete(s.id);
                }
            });

            list.appendChild(item);

            // Numbered Marker
            const el = document.createElement('div');
            el.className = `marker ${s.status}`;
            el.innerText = i + 1;
            el.onclick = (e) => { e.stopPropagation(); focusItem(s.id); };

            const m = new mapboxgl.Marker(el).setLngLat([s.lng, s.lat]).addTo(map);
            markers.push(m);
            bounds.extend([s.lng, s.lat]);
        });

        if (stops.length > 0) map.fitBounds(bounds, { padding: 60, maxZoom: 15 });
    }

    function focusItem(id) {
        const stop = stops.find(s => s.id == id);
        const el = document.getElementById(`item-${id}`);
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.classList.add('highlight');
        setTimeout(() => el.classList.remove('highlight'), 2000);
        map.flyTo({ center: [stop.lng, stop.lat], zoom: 16 });
    }

    function completeStop(id) {
        const idx = stops.findIndex(s => s.id == id);
        stops[idx].status = 'completed';
        render();
        
        // Scroll next active stop to top
        const active = document.querySelectorAll('.stop-item:not(.completed)');
        if (active.length > 0) active[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function confirmDelete(id) {
        currentDeleteId = id;
        showModal("Delete Order?", "Are you sure you want to delete this order from the route?", [
            { text: "Cancel", cb: () => showModal(null) },
            { text: "Delete", color: "var(--red)", cb: () => {
                stops.find(s => s.id == currentDeleteId).status = 'cancelled';
                showModal(null);
                render();
                showControls();
            }}
        ]);
    }

    async function triggerSync(action) {
        const text = action === 'optimize' ? 'Re-optimizing' : 'Re-calculating';
        showModal("Start Time", "Choose a starting point for ETAs:", [
            { text: "8:00 AM", cb: () => finalizeSync(action, "8:00 AM", text) },
            { text: "Current", cb: () => finalizeSync(action, new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), text) },
            { text: "Custom", cb: () => finalizeSync(action, prompt("Enter time (e.g. 10:30 AM)"), text) }
        ]);
    }

    async function finalizeSync(action, startTime, msg) {
        showModal(null);
        showLoader(msg + "...");
        try {
            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action, routeId, driver, stops, startTime, startAddr: document.getElementById('start-node').value, endAddr: document.getElementById('end-node').value })
            });
            const data = await res.json();
            stops = data.updatedStops;
            document.getElementById('controls').style.display = 'none';
            render();
        } catch (e) { alert("Sync failed."); }
        showLoader(null);
    }

    function openNativeNav(lat, lng) {
        const url = (navigator.platform.indexOf('iPhone') != -1) 
            ? `maps://maps.apple.com/?daddr=${lat},${lng}` 
            : `google.navigation:q=${lat},${lng}`;
        window.location.href = url;
    }

    function showControls() {
        document.getElementById('controls').style.display = 'flex';
    }

    function showLoader(text) {
        const l = document.getElementById('loader');
        l.style.display = text ? 'block' : 'none';
        if (text) l.innerText = text;
    }

    function showModal(title, body, btns) {
        const m = document.getElementById('modal-overlay');
        if (!title) { m.style.display = 'none'; return; }
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerText = body;
        const btnBox = document.getElementById('modal-btns');
        btnBox.innerHTML = '';
        btns.forEach(b => {
            const btn = document.createElement('button');
            btn.innerText = b.text;
            btn.style.flex = "1";
            btn.style.padding = "12px";
            btn.style.border = "none";
            btn.style.borderRadius = "6px";
            btn.style.background = b.color || "#eee";
            btn.style.color = b.color ? "white" : "black";
            btn.style.fontWeight = "bold";
            btn.onclick = b.cb;
            btnBox.appendChild(btn);
        });
        m.style.display = 'flex';
    }

    Sortable.create(document.getElementById('stop-list'), {
        handle: '.handle',
        animation: 150,
        delay: 100,
        delayOnTouchOnly: true,
        onEnd: showControls
    });

    loadData();
</script>
</body>
</html>
