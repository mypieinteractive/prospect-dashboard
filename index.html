<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ProSpect Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #2b579a; --red: #d93025; --green: #28a745; }
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: #fff; }
        #map { flex: 1; position: relative; width: 100%; z-index: 1; }
        #sidebar { height: 50vh; display: flex; flex-direction: column; background: white; z-index: 10; border-top: 3px solid #ddd; }
        
        /* List & Swipe */
        .stop-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; transition: transform 0.3s; position: relative; touch-action: pan-y; }
        .stop-item.completed { background: #f0f0f0; opacity: 0.6; }
        .swipe-delete { position: absolute; right: -100px; background: var(--red); color: white; height: 100%; width: 100px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* Icons & UI */
        .check-icon { font-size: 28px; color: var(--green); margin-left: 15px; }
        .handle { padding: 15px; color: #ccc; cursor: grab; }
        .status-msg { color: var(--red); font-weight: bold; font-size: 12px; display: none; margin-left: 10px; }
        .controls { display: none; padding: 10px; background: #eee; gap: 10px; align-items: center; }
        
        /* Numbered Pins */
        .marker { width: 30px; height: 30px; background: var(--red); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .marker.completed { background: #999; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
    <div id="controls" class="controls">
        <span class="status-msg" id="change-alert">Changes made</span>
        <button class="btn-opt" onclick="triggerSync('optimize')">Re-Optimize</button>
        <button class="btn-calc" onclick="triggerSync('calculate')">Re-Calculate</button>
    </div>
    <div id="stop-list"></div>
</div>

<script>
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibXlwaWVpbnRlcmFjdGl2ZSIsImEiOiJjbWx2ajk5Z2MwOGZlM2VwcDBkc295dzI1In0.eGIhcRPrj_Hx_PeoFAYxBA';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx_1YmGxRQI3YNvBUiJnlAwkKg-REnGFSZbn8fyqeijjXXLN009g5ziIY8DNdtFA_4D/exec';
    
    const params = new URLSearchParams(window.location.search);
    const routeId = params.get('id');
    const driver = params.get('driver');

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-96.797, 32.776],
        zoom: 11
    });

    let stops = [];
    let markers = [];

    // --- RENDER LOGIC ---
    function render() {
        const list = document.getElementById('stop-list');
        list.innerHTML = '';
        markers.forEach(m => m.remove());
        markers = [];

        stops.forEach((s, i) => {
            if (s.status === 'cancelled') return;

            // 1. Sidebar Item
            const item = document.createElement('div');
            item.className = `stop-item ${s.status}`;
            item.id = `stop-${s.id}`;
            item.innerHTML = `
                <div class="handle">â˜°</div>
                <div style="flex:1" onclick="openNav('${s.lat}','${s.lng}')">
                    <b>${i + 1}. ${s.address.split(',')[0]}</b><br>
                    <small>${s.eta} | ${s.dist}</small>
                </div>
                <i class="fa-solid fa-circle-check check-icon" onclick="completeStop('${s.id}')"></i>
            `;
            list.appendChild(item);

            // 2. Custom Numbered Pin
            const el = document.createElement('div');
            el.className = `marker ${s.status}`;
            el.innerText = i + 1;
            el.onclick = () => { focusItem(s.id); };

            const marker = new mapboxgl.Marker(el)
                .setLngLat([s.lng, s.lat])
                .addTo(map);
            markers.push(marker);
        });
    }

    // --- GESTURES & ACTIONS ---
    function completeStop(id) {
        const idx = stops.findIndex(s => s.id == id);
        stops[idx].status = 'completed';
        render();
        // Scroll next stop to top
        const next = document.getElementById(`stop-${stops[idx+1]?.id}`);
        if(next) next.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function openNav(lat, lng) {
        // Fix for invalid address: Use coordinates directly
        window.location.href = `maps://maps.apple.com/?daddr=${lat},${lng}`;
    }

    function focusItem(id) {
        const el = document.getElementById(`stop-${id}`);
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        el.style.background = "#fff9c4";
        setTimeout(() => { el.style.background = "white"; }, 2000);
    }

    // --- SYNC ---
    async function triggerSync(type) {
        let startTime = "8:00 AM";
        const choice = prompt("Use (1) Default 8AM, (2) Current Time, or (3) Custom?");
        if(choice === "2") startTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        if(choice === "3") startTime = prompt("Enter time (e.g. 10:30 AM)");

        document.getElementById('change-alert').innerText = action === 'optimize' ? "Re-optimizing..." : "Re-calculating...";
        
        const res = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify({ action: type, routeId, stops, startTime })
        });
        const data = await res.json();
        stops = data.updatedStops;
        render();
    }

    // Sortable Init
    Sortable.create(document.getElementById('stop-list'), {
        handle: '.handle',
        onEnd: () => { 
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('change-alert').style.display = 'inline';
        }
    });

    // Initial Load
    fetch(`${WEB_APP_URL}?id=${routeId}`).then(r => r.json()).then(d => { stops = d; render(); });
</script>
</body>
</html>
