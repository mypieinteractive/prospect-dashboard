<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ProSpect Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --blue: #2b579a; --red: #d93025; --green: #28a745; --purple: #6C5C99; }
        * { box-sizing: border-box; font-family: Calibri, 'Candara', 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; background: #fff; overflow: hidden; }
        
        #map-wrapper { height: 45vh; width: 100%; position: relative; border-bottom: 2px solid #ccc; background-color: #f0f0f0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        
        #sidebar { flex: 1; display: flex; flex-direction: column; background: white; z-index: 10; border-top: 3px solid #ddd; position: relative; }
        #stop-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* REFINED TILE STRUCTURE */
        .stop-item { display: flex; align-items: stretch; border-bottom: 1px solid #eee; background: white; min-height: 80px; }
        .stop-item.completed { opacity: 0.5; background: #f9f9f9; }
        .stop-item.highlight { background: #fff9c4 !important; }

        /* LEFT SIDEBAR: STOP NUMBER */
        .stop-sidebar { 
            width: 45px; 
            background-color: var(--purple); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 18px; 
        }

        .handle { padding: 15px 10px; color: #ccc; cursor: grab; font-size: 18px; display: flex; align-items: center; }

        /* MIDDLE CONTENT */
        .stop-content { flex: 1; padding: 10px 5px; display: flex; flex-direction: column; justify-content: center; }
        .stop-content b { font-size: 16px; color: #333; display: block; line-height: 1.2; }
        .row-meta { font-size: 13px; color: #666; margin-top: 3px; }
        .row-details { font-size: 12px; color: #888; margin-top: 2px; }

        /* RIGHT ACTIONS */
        .stop-actions { display: flex; align-items: center; padding-right: 10px; gap: 5px; }
        
        /* CSV TYPE BOX */
        .csv-box { 
            width: 32px; height: 32px; 
            border: 2px solid var(--blue); 
            color: var(--blue); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 11px; 
            border-radius: 4px; 
            cursor: pointer;
            margin-right: 5px;
        }

        .icon-btn { font-size: 28px; cursor: pointer; padding: 5px; }
        .check-icon { color: var(--green); }
        .nav-icon { color: var(--blue); }

        #controls { display: none; padding: 10px; background: #f1f4f9; border-bottom: 1px solid #ddd; align-items: center; justify-content: center; gap: 10px; }
        .marker { width: 32px; height: 32px; background: var(--red); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 14px; }
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; align-items:center; justify-content:center; }
        .modal-box { background:white; padding:25px; border-radius:12px; width:85%; max-width:340px; text-align: center; }
        select, input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; }
        .modal-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 15px; flex: 1; }
    </style>
</head>
<body>

<div id="map-wrapper"><div id="map"></div></div>

<div id="sidebar">
    <div id="controls">
        <span style="color:var(--red); font-weight:bold; font-size:14px;">Changes made</span>
        <button onclick="showSyncOptions('optimize')" style="background:var(--blue); color:white; padding:8px 18px; border:none; border-radius:4px; font-weight:bold;">Re-Optimize</button>
        <button onclick="showSyncOptions('calculate')" style="background:#444; color:white; padding:8px 18px; border:none; border-radius:4px; font-weight:bold;">Re-Calculate</button>
    </div>
    <div id="stop-list"></div>
</div>

<div id="modal-overlay"><div class="modal-box" id="modal-content"></div></div>

<script>
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibXlwaWVpbnRlcmFjdGl2ZSIsImEiOiJjbWx2ajk5Z2MwOGZlM2VwcDBkc295dzI1In0.eGIhcRPrj_Hx_PeoFAYxBA';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwUcV6_7hBLb41N2M3aWEjbJtCGAb0Yeke8537P3ETml-RfMRV4msv_y6P5HctvuxqV/exec';
    
    const params = new URLSearchParams(window.location.search);
    const routeId = params.get('id');
    const driver = params.get('driver');

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [-96.797, 32.776],
        zoom: 11
    });

    map.on('load', () => { map.resize(); });

    let stops = [];
    let markers = [];
    let defaultStart = "", defaultEnd = "";

    async function loadData() {
        if (!routeId) return;
        try {
            const res = await fetch(`${WEB_APP_URL}?id=${routeId}`);
            stops = await res.json();
            if (stops.length > 0) {
                defaultStart = stops[0].address;
                defaultEnd = stops[stops.length - 1].address;
            }
            render();
        } catch (e) { console.error("Data load failed", e); }
    }

    function render() {
        const list = document.getElementById('stop-list');
        list.innerHTML = ''; markers.forEach(m => m.remove()); markers = [];
        const bounds = new mapboxgl.LngLatBounds();

        stops.filter(s => s.status !== 'cancelled').forEach((s, i) => {
            const item = document.createElement('div');
            item.className = `stop-item ${s.status}`;
            item.id = `item-${s.id}`;
            
            // Format App Label (2 chars)
            const appLabel = (s.client && s.client.length >= 2) ? s.client.substring(0,2).toUpperCase() : "??";

            item.innerHTML = `
                <div class="stop-sidebar">${i + 1}</div>
                <div class="handle">â˜°</div>
                <div class="stop-content" onclick="focusItem('${s.id}')">
                    <b>${s.address.split(',')[0]}</b>
                    <div class="row-meta">${s.eta} | ${s.dist}</div>
                    <div class="row-details">${s.type}</div>
                </div>
                <div class="stop-actions">
                    <div class="csv-box" onclick="openVendorApp('${s.client}')">${appLabel}</div>
                    <i class="fa-solid fa-circle-check icon-btn check-icon" onclick="toggleComplete('${s.id}')"></i>
                    <i class="fa-solid fa-location-arrow icon-btn nav-icon" onclick="openNav('${s.lat}','${s.lng}')"></i>
                </div>
            `;
            
            let startX = 0;
            item.addEventListener('touchstart', (e) => startX = e.touches[0].clientX);
            item.addEventListener('touchend', (e) => { if (startX - e.changedTouches[0].clientX > 80) triggerDelete(s.id); });
            list.appendChild(item);

            const el = document.createElement('div');
            el.className = `marker ${s.status}`; el.innerText = i + 1;
            el.onclick = () => focusItem(s.id);
            const m = new mapboxgl.Marker(el).setLngLat([s.lng, s.lat]).addTo(map);
            markers.push(m); bounds.extend([s.lng, s.lat]);
        });
        if (stops.length > 0) map.fitBounds(bounds, { padding: 50, maxZoom: 15 });
    }

    function toggleComplete(id) {
        const idx = stops.findIndex(s => s.id == id);
        stops[idx].status = (stops[idx].status === 'completed') ? '' : 'completed';
        render();
    }

    function focusItem(id) {
        const stop = stops.find(s => s.id == id);
        document.getElementById(`item-${id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
        map.flyTo({ center: [stop.lng, stop.lat], zoom: 16 });
    }

    function openVendorApp(appName) {
        alert("Navigating to " + appName + " (Link to be added in Sheet settings)");
    }

    function openNav(lat, lng) {
        let pref = localStorage.getItem('navPref');
        if (!pref) { showNavChoice(lat, lng); } else { launchMaps(pref, lat, lng); }
    }

    function showNavChoice(lat, lng) {
        const modal = document.getElementById('modal-overlay');
        modal.style.display = 'flex';
        document.getElementById('modal-content').innerHTML = `<h3>Select your preferred Maps App:</h3><div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;"><button class="modal-btn" style="background:var(--blue); color:white;" onclick="setNavPref('google','${lat}','${lng}')">Google Maps</button><button class="modal-btn" style="background:#eee; color:#333;" onclick="setNavPref('apple','${lat}','${lng}')">Apple Maps</button></div>`;
    }

    function setNavPref(pref, lat, lng) {
        localStorage.setItem('navPref', pref);
        document.getElementById('modal-overlay').style.display = 'none';
        launchMaps(pref, lat, lng);
    }

    function launchMaps(pref, lat, lng) {
        const url = pref === 'google' ? `comgooglemaps://?daddr=${lat},${lng}` : `maps://maps.apple.com/?daddr=${lat},${lng}`;
        window.location.href = url;
    }

    function showSyncOptions(type) {
        const modal = document.getElementById('modal-overlay');
        modal.style.display = 'flex';
        let timeOptions = '';
        for(let h=6; h<=18; h++){
            let hr = h > 12 ? h-12 : h; let ampm = h >= 12 ? 'PM' : 'AM';
            timeOptions += `<option value="${hr}:00 ${ampm}">${hr}:00 ${ampm}</option><option value="${hr}:30 ${ampm}">${hr}:30 ${ampm}</option>`;
        }
        document.getElementById('modal-content').innerHTML = `<h3 style="margin-top:0">${type === 'optimize' ? 'Re-Optimize Route' : 'Update Times'}</h3><label style="display:block; text-align:left; font-weight:bold; font-size:14px;">Start Time:</label><select id="start-time-select">${timeOptions}</select><label style="display:block; text-align:left; font-weight:bold; font-size:14px; margin-top:10px;">Start Address:</label><input type="text" id="start-addr" value="${defaultStart}"><label style="display:block; text-align:left; font-weight:bold; font-size:14px; margin-top:10px;">End Address:</label><input type="text" id="end-addr" value="${defaultEnd}"><div style="display:flex; gap:10px; margin-top:20px;"><button class="modal-btn" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button><button class="modal-btn" style="background:var(--blue); color:white;" onclick="finalizeSync('${type}')">Submit</button></div>`;
    }

    async function finalizeSync(type) {
        const startTime = document.getElementById('start-time-select').value;
        const startAddr = document.getElementById('start-addr').value;
        const endAddr = document.getElementById('end-addr').value;
        document.getElementById('modal-overlay').style.display = 'none';
        try {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: type, routeId, driver, stops, startTime, startAddr, endAddr }) });
            const data = await res.json(); stops = data.updatedStops;
            document.getElementById('controls').style.display = 'none'; render();
        } catch (e) { alert("Sync Failed."); }
    }

    function triggerDelete(id) {
        if(confirm("Are you sure you want to delete this order from the route?")) {
            stops.find(s => s.id == id).status = 'cancelled'; render();
            document.getElementById('controls').style.display = 'flex';
        }
    }

    Sortable.create(document.getElementById('stop-list'), { handle: '.handle', animation: 150, onEnd: () => { document.getElementById('controls').style.display = 'flex'; } });
    loadData();
</script>
</body>
</html>
