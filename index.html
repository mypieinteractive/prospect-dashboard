<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ProSpect Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --blue: #2b579a; --fade-blue: #eef2f9; --red: #d93025; --green: #28a745; --purple: #6C5C99; }
        * { box-sizing: border-box; font-family: Calibri, 'Candara', 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; display: flex; background: #fff; overflow: hidden; }
        
        /* VIEWS */
        body.view-driver { flex-direction: column; }
        .view-driver #map-wrapper { height: 40vh; min-height: 40vh; width: 100%; border-bottom: 2px solid #ccc; }
        .view-driver #sidebar { height: 60vh; min-height: 60vh; width: 100%; }

        body.view-admin { flex-direction: row; }
        .view-admin #sidebar { width: 350px; height: 100vh; border-right: 2px solid #ccc; font-size: 0.9em; }
        .view-admin #map-wrapper { flex: 1; height: 100vh; }

        #map-wrapper { position: relative; background-color: #efefef; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        
        /* INSTRUCTION NOTE */
        #selection-note {
            position: absolute; top: 10px; left: 10px; z-index: 150;
            background: rgba(255, 255, 255, 0.85); padding: 6px 10px;
            border-radius: 4px; border: 1px solid #ccc; font-size: 11px;
            color: #444; pointer-events: none; max-width: 180px;
            line-height: 1.3; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* BOX SELECTION UI */
        .boxdraw { background: rgba(43, 87, 154, 0.2); border: 2px solid var(--blue); position: absolute; top: 0; left: 0; width: 0; height: 0; z-index: 100; pointer-events: none; }

        /* FLOATING ACTION BUTTONS */
        .map-overlay-btns { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .floating-btn { background: white; border: 1px solid #ccc; border-radius: 20px; padding: 8px 16px; font-weight: bold; font-size: 13px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: none; white-space: nowrap; }
        #bulk-remove-btn { background: var(--red); color: white; border-color: var(--red); }
        #bulk-complete-btn { background: var(--green); color: white; border-color: var(--green); }
        #reset-view-btn { display: none; }

        #sidebar { display: flex; flex-direction: column; background: white; z-index: 10; }
        #search-container { padding: 8px; border-bottom: 1px solid #ddd; }
        #search-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        #stop-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* TILE STRUCTURE */
        .stop-item { display: flex; align-items: stretch; border-bottom: 1px solid #eee; background: white; min-height: 62px; }
        .stop-item.completed { opacity: 0.5; background: #f9f9f9; }
        .stop-item.selected { background: var(--fade-blue) !important; }
        .stop-sidebar { width: 32px; background-color: var(--purple); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 15px; }
        .handle { padding: 0 5px; color: #ccc; cursor: grab; font-size: 16px; display: flex; align-items: center; }
        .csv-box { align-self: center; width: 26px; height: 26px; border: 1.5px solid var(--blue); color: var(--blue); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 9px; border-radius: 4px; margin: 0 6px; }
        .stop-content { flex: 1; padding: 4px 0; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .stop-content b { font-size: 15px; color: #333; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .row-meta { font-size: 12px; color: #666; margin-top: 1px; }
        .row-details { font-size: 11px; color: #888; margin-top: 1px; }
        .due-warning { color: var(--red); font-weight: bold; }

        .stop-actions { display: flex; align-items: center; padding-right: 8px; gap: 4px; }
        .icon-btn { font-size: 24px; cursor: pointer; padding: 4px; }
        .check-icon { color: var(--green); }
        .nav-icon { color: var(--blue); }
        .more-icon { color: #888; }
        
        #context-menu { position: fixed; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 3000; border-radius: 6px; display: none; overflow: hidden; }
        .context-item { padding: 12px 20px; font-weight: bold; cursor: pointer; color: var(--red); font-size: 14px; }
        .context-item:hover { background: #f5f5f5; }

        #controls { display: none; padding: 8px; background: #f1f4f9; border-bottom: 1px solid #ddd; align-items: center; justify-content: center; gap: 8px; }
        .marker { width: 28px; height: 28px; background: var(--red); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 12px; cursor: pointer; }
        .marker.bulk-selected { background: var(--blue) !important; box-shadow: 0 0 10px var(--blue); }
        .marker.completed { background: #999; }
        
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; align-items:center; justify-content:center; }
        .modal-box { background:white; padding:20px; border-radius:12px; width:85%; max-width:340px; text-align: center; }
    </style>
</head>
<body class="view-driver" onclick="hideContextMenu()">

<div id="map-wrapper">
    <div id="selection-note">
        <b>Desktop:</b> Shift + Drag to select multiple<br>
        <b>Mobile:</b> Long Press + Drag to select multiple
    </div>
    <div class="map-overlay-btns">
        <button id="reset-view-btn" class="floating-btn" onclick="resetMapView()">Reset View</button>
        <button id="bulk-complete-btn" class="floating-btn" onclick="triggerBulkComplete()">Mark selected as completed</button>
        <button id="bulk-remove-btn" class="floating-btn" onclick="triggerBulkDelete()">Remove orders from route</button>
    </div>
    <div id="map"></div>
</div>

<div id="sidebar">
    <div id="search-container"><input type="text" id="search-input" placeholder="Search address or client..." onkeyup="filterList()"></div>
    <div id="controls">
        <span style="color:var(--red); font-weight:bold; font-size:13px;">Changes made</span>
        <button onclick="showSyncOptions('optimize')" style="background:var(--blue); color:white; padding:6px 14px; border:none; border-radius:4px; font-weight:bold; font-size:12px;">Re-Optimize</button>
        <button onclick="showSyncOptions('calculate')" style="background:#444; color:white; padding:6px 14px; border:none; border-radius:4px; font-weight:bold; font-size:12px;">Re-Calculate</button>
    </div>
    <div id="stop-list"></div>
</div>

<div id="context-menu"><div class="context-item" id="context-delete-btn">Remove order from route</div></div>
<div id="modal-overlay"><div class="modal-box" id="modal-content"></div></div>

<script>
    const MAPBOX_TOKEN = 'pk.eyJ1IjoibXlwaWVpbnRlcmFjdGl2ZSIsImEiOiJjbWx2ajk5Z2MwOGZlM2VwcDBkc295dzI1In0.eGIhcRPrj_Hx_PeoFAYxBA';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwUcV6_7hBLb41N2M3aWEjbJtCGAb0Yeke8537P3ETml-RfMRV4msv_y6P5HctvuxqV/exec';
    
    const params = new URLSearchParams(window.location.search), routeId = params.get('id'), driver = params.get('driver'), viewMode = params.get('view') || 'driver';
    document.body.className = `view-${viewMode}`;

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/streets-v12', center: [-96.797, 32.776], zoom: 11 });

    let stops = [], markers = [], initialBounds = null, selectedIds = new Set();

    // --- BOX SELECTION LOGIC ---
    let start, current, box, longPressActive = false, pressTimer;
    const canvas = map.getCanvasContainer();

    canvas.addEventListener('mousedown', mouseDown, true);
    canvas.addEventListener('touchstart', (e) => {
        pressTimer = window.setTimeout(() => { longPressActive = true; mouseDown(e.touches[0]); }, 700);
    }, {passive: true});
    canvas.addEventListener('touchend', () => { clearTimeout(pressTimer); if(!longPressActive) map.dragPan.enable(); });

    function mousePos(e) {
        const rect = canvas.getBoundingClientRect();
        return new mapboxgl.Point(e.clientX - rect.left - canvas.clientLeft, e.clientY - rect.top - canvas.clientTop);
    }

    function mouseDown(e) {
        if (!e.shiftKey && !longPressActive) return;
        map.dragPan.disable();
        document.addEventListener('mousemove', mouseMove);
        document.addEventListener('mouseup', mouseUp);
        document.addEventListener('touchmove', (te) => mouseMove(te.touches[0]));
        document.addEventListener('touchend', (te) => mouseUp(te.changedTouches[0]));
        start = mousePos(e);
    }

    function mouseMove(e) {
        current = mousePos(e);
        if (!box) {
            box = document.createElement('div');
            box.classList.add('boxdraw');
            canvas.appendChild(box);
        }
        const minX = Math.min(start.x, current.x), maxX = Math.max(start.x, current.x);
        const minY = Math.min(start.y, current.y), maxY = Math.max(start.y, current.y);
        box.style.transform = `translate(${minX}px, ${minY}px)`;
        box.style.width = maxX - minX + 'px';
        box.style.height = maxY - minY + 'px';
    }

    function mouseUp(e) { finishSelection(mousePos(e)); longPressActive = false; }

    function finishSelection(e) {
        document.removeEventListener('mousemove', mouseMove);
        document.removeEventListener('mouseup', mouseUp);
        if (box) { box.parentNode.removeChild(box); box = null; }
        if (!start) return;
        const bounds = [start, e];
        const boxFeatures = markers.filter(m => {
            const point = map.project(m.getLngLat());
            return point.x >= Math.min(bounds[0].x, bounds[1].x) && point.x <= Math.max(bounds[0].x, bounds[1].x) &&
                   point.y >= Math.min(bounds[0].y, bounds[1].y) && point.y <= Math.max(bounds[0].y, bounds[1].y);
        });
        selectedIds.clear();
        boxFeatures.forEach(m => selectedIds.add(m._stopId));
        updateSelectionUI();
        map.dragPan.enable();
        start = null;
    }

    function updateSelectionUI() {
        document.querySelectorAll('.stop-item').forEach(el => el.classList.remove('selected'));
        markers.forEach(m => {
            m.getElement().classList.remove('bulk-selected');
            if (selectedIds.has(m._stopId)) {
                m.getElement().classList.add('bulk-selected');
                const el = document.getElementById(`item-${m._stopId}`);
                if (el) el.classList.add('selected');
            }
        });
        const hasBulk = selectedIds.size > 1;
        document.getElementById('bulk-remove-btn').style.display = hasBulk ? 'block' : 'none';
        document.getElementById('bulk-complete-btn').style.display = hasBulk ? 'block' : 'none';
    }

    // --- MAIN ENGINE ---
    async function loadData() {
        if (!routeId) return;
        try {
            const res = await fetch(`${WEB_APP_URL}?id=${routeId}`);
            stops = await res.json();
            render(); drawRoute();
        } catch (e) { console.error(e); }
    }

    function render() {
        const list = document.getElementById('stop-list');
        list.innerHTML = ''; markers.forEach(m => m.remove()); markers = [];
        const bounds = new mapboxgl.LngLatBounds();

        stops.filter(s => s.status !== 'cancelled').forEach((s, i) => {
            const item = document.createElement('div');
            item.className = `stop-item ${s.status}`;
            item.id = `item-${s.id}`;
            item.setAttribute('data-search', `${s.address} ${s.client}`.toLowerCase());
            const due = s.dueDate ? new Date(s.dueDate) : null;
            const dueFmt = due ? `${due.getMonth()+1}/${due.getDate()}` : "N/A";
            const dueHtml = (due && due <= new Date()) ? `<span class="due-warning">⚠️ ${dueFmt}</span>` : dueFmt;

            item.innerHTML = `
                <div class="stop-sidebar">${i + 1}</div>
                <div class="handle">☰</div>
                <div class="csv-box">${(s.client||"??").substring(0,2).toUpperCase()}</div>
                <div class="stop-content" onclick="focusItem('${s.id}')">
                    <b>${s.address.split(',')[0]}</b>
                    <div class="row-meta">${s.eta} | ${s.dist}</div>
                    <div class="row-details">${dueHtml} | ${s.type}</div>
                </div>
                <div class="stop-actions">
                    <i class="fa-solid fa-circle-check icon-btn check-icon" onclick="toggleComplete('${s.id}')"></i>
                    <i class="fa-solid fa-location-arrow icon-btn nav-icon" onclick="openNav('${s.lat}','${s.lng}')"></i>
                    <i class="fa-solid fa-ellipsis-vertical icon-btn more-icon" onclick="showActionMenu(event, '${s.id}')"></i>
                </div>
            `;
            list.appendChild(item);

            const el = document.createElement('div');
            el.className = `marker ${s.status}`; el.innerText = i + 1;
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); showActionMenu(e, s.id); });
            el.onclick = () => { selectedIds.clear(); selectedIds.add(s.id); updateSelectionUI(); focusItem(s.id); };
            const m = new mapboxgl.Marker(el).setLngLat([s.lng, s.lat]).addTo(map);
            m._stopId = s.id; markers.push(m); bounds.extend([s.lng, s.lat]);
        });
        if (stops.length > 0) { initialBounds = bounds; map.fitBounds(bounds, { padding: 50, maxZoom: 15 }); }
    }

    function triggerBulkDelete() {
        if(confirm(`Remove ${selectedIds.size} orders from route?`)) {
            selectedIds.forEach(id => { stops.find(s => s.id == id).status = 'cancelled'; });
            selectedIds.clear(); render(); drawRoute(); updateSelectionUI();
            document.getElementById('controls').style.display = 'flex';
        }
    }

    function triggerBulkComplete() {
        if(confirm(`Mark ${selectedIds.size} orders as completed?`)) {
            selectedIds.forEach(id => { stops.find(s => s.id == id).status = 'completed'; });
            selectedIds.clear(); render(); drawRoute(); updateSelectionUI();
            document.getElementById('controls').style.display = 'flex';
        }
    }

    function triggerDelete(id) {
        if(confirm("Remove order from route?")) { 
            stops.find(s => s.id == id).status = 'cancelled'; 
            render(); drawRoute(); document.getElementById('controls').style.display = 'flex'; 
        }
    }

    // Helper functions...
    function showActionMenu(e, id) {
        e.stopPropagation(); const menu = document.getElementById('context-menu');
        const x = e.clientX || e.pageX, y = e.clientY || e.pageY;
        menu.style.left = `${x - 100}px`; menu.style.top = `${y}px`; menu.style.display = 'block';
        document.getElementById('context-delete-btn').onclick = () => { triggerDelete(id); hideContextMenu(); };
    }
    function hideContextMenu() { document.getElementById('context-menu').style.display = 'none'; }
    function resetMapView() { if (initialBounds) map.fitBounds(initialBounds, { padding: 50, maxZoom: 15 }); }
    function filterList() {
        const q = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('.stop-item').forEach(el => el.style.display = el.getAttribute('data-search').includes(q) ? 'flex' : 'none');
    }
    function drawRoute() {
        const act = stops.filter(s => s.status !== 'cancelled'); if (act.length < 2) return;
        const crd = act.map(s => [s.lng, s.lat]);
        if (map.getSource('route')) map.getSource('route').setData({ "type": "Feature", "geometry": { "type": "LineString", "coordinates": crd } });
        else {
            map.addSource('route', { "type": "geojson", "data": { "type": "Feature", "geometry": { "type": "LineString", "coordinates": crd } } });
            map.addLayer({ "id": "route", "type": "line", "source": "route", "layout": { "line-join": "round", "line-cap": "round" }, "paint": { "line-color": "#2b579a", "line-width": 4, "line-opacity": 0.5 } });
        }
    }
    function focusItem(id) {
        document.querySelectorAll('.stop-item').forEach(el => el.classList.remove('selected'));
        const stop = stops.find(s => s.id == id), el = document.getElementById(`item-${id}`);
        if(el) { el.classList.add('selected'); el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        map.flyTo({ center: [stop.lng, stop.lat], zoom: 16 });
    }
    function toggleComplete(id) { const idx = stops.findIndex(s => s.id == id); stops[idx].status = (stops[idx].status === 'completed') ? '' : 'completed'; render(); drawRoute(); }
    function openNav(lat, lng) { let pref = localStorage.getItem('navPref'); if (!pref) { showNavChoice(lat, lng); } else { launchMaps(pref, lat, lng); } }
    function showNavChoice(lat, lng) { const modal = document.getElementById('modal-overlay'); modal.style.display = 'flex'; document.getElementById('modal-content').innerHTML = `<h3>Maps Preference:</h3><div style="display:flex; flex-direction:column; gap:8px;"><button style="padding:12px; border:none; border-radius:6px; background:var(--blue); color:white; font-weight:bold;" onclick="setNavPref('google','${lat}','${lng}')">Google Maps</button><button style="padding:12px; border:none; border-radius:6px; background:#eee;" onclick="setNavPref('apple','${lat}','${lng}')">Apple Maps</button></div>`; }
    function setNavPref(pref, lat, lng) { localStorage.setItem('navPref', pref); document.getElementById('modal-overlay').style.display = 'none'; launchMaps(pref, lat, lng); }
    function launchMaps(pref, lat, lng) { const url = pref === 'google' ? `comgooglemaps://?daddr=${lat},${lng}` : `maps://maps.apple.com/?daddr=${lat},${lng}`; window.location.href = url; }
    function showSyncOptions(type) {
        const modal = document.getElementById('modal-overlay'); modal.style.display = 'flex';
        let tOpt = ''; for(let h=6; h<=18; h++){ let hr = h>12?h-12:h; let ap = h>=12?'PM':'AM'; tOpt += `<option value="${hr}:00 ${ap}">${hr}:00 ${ap}</option><option value="${hr}:30 ${ap}">${hr}:30 ${ap}</option>`; }
        const defS = stops.length ? stops[0].address : "", defE = stops.length ? stops[stops.length-1].address : "";
        document.getElementById('modal-content').innerHTML = `<h3 style="margin-top:0">Update Route</h3><select id="start-time-select" style="width:100%; padding:8px; margin:5px 0;">${tOpt}</select><input type="text" id="start-addr" value="${defS}" style="width:100%; padding:8px; margin:5px 0;"><input type="text" id="end-addr" value="${defE}" style="width:100%; padding:8px; margin:5px 0;"><div style="display:flex; gap:10px; margin-top:20px;"><button style="flex:1; padding:10px; border:none; border-radius:6px;" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button><button style="flex:1; padding:10px; border:none; border-radius:6px; background:var(--blue); color:white; font-weight:bold;" onclick="finalizeSync('${type}')">Submit</button></div>`;
    }
    async function finalizeSync(type) {
        const startTime = document.getElementById('start-time-select').value, startAddr = document.getElementById('start-addr').value, endAddr = document.getElementById('end-addr').value;
        document.getElementById('modal-overlay').style.display = 'none';
        try {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: type, routeId, driver, stops, startTime, startAddr, endAddr }) });
            const data = await res.json(); stops = data.updatedStops;
            document.getElementById('controls').style.display = 'none'; render(); drawRoute();
        } catch (e) { alert("Sync Failed."); }
    }

    map.on('zoomend', () => { document.getElementById('reset-view-btn').style.display = map.getZoom() > 12 ? 'block' : 'none'; });
    Sortable.create(document.getElementById('stop-list'), { handle: '.handle', animation: 150, onEnd: () => { document.getElementById('controls').style.display = 'flex'; } });
    loadData();
</script>
</body>
</html>
