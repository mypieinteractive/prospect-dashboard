<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sproute Dashboard</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { 
            --blue: #2563eb; 
            --fade-blue: rgba(37, 99, 235, 0.2); 
            --red: #e74c3c; 
            --green: #10b981; 
            --purple: #8e44ad; 
            --orange: #f39c12; 
            --bg-base: #121212;
            --bg-panel: #1e1e1e;
            --bg-hover: #2a2a2a;
            --bg-header: #171E26;
            --border-color: #333333;
            --text-main: #e0e0e0;
            --text-muted: #888888;
        }
        
        * { box-sizing: border-box; font-family: Calibri, 'Candara', 'Segoe UI', sans-serif; }
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; display: flex; background: var(--bg-base); color: var(--text-main); overflow: hidden; }
        
        /* SHIFT-CLICK HIGHLIGHT FIX */
        .stop-item, .glide-row, .marker, .glide-table-header {
            user-select: none;
            -webkit-user-select: none;
        }

        /* VIEW MODES */
        body.view-driver { flex-direction: column; }
        .view-driver #map-wrapper { height: 35vh; min-height: 35vh; width: 100%; border-bottom: 2px solid var(--border-color); }
        .view-driver #sidebar { height: 65vh; min-height: 65vh; width: 100%; }

        body.view-admin { flex-direction: row; }
        .view-admin #sidebar { width: 480px; height: 100vh; border-right: 2px solid var(--border-color); }
        .view-admin #map-wrapper { flex: 1; height: 100vh; }
        .view-admin .stop-actions { display: none !important; }
        body.view-admin #bulk-complete-btn { display: none !important; }

        body.view-map #sidebar { display: none !important; }
        body.view-map #map-wrapper { height: 100vh; width: 100vw; }

        body.view-list #map-wrapper { display: none !important; }
        body.view-list #sidebar { width: 100vw; height: 100vh; max-width: none; border-right: none; }

        /* MANAGER VIEW */
        body.view-manager { flex-direction: row; }
        body.view-manager #map-wrapper { flex: 1; height: 100vh; width: auto; }
        body.view-manager #sidebar { width: 50vw; min-width: 10vw; height: 100vh; border-left: none; flex: none; }
        body.view-manager #bulk-complete-btn { display: none !important; }
        body.view-manager #route-summary { display: none !important; }

        /* RESIZER / SLIDER */
        #resizer {
            width: 6px;
            background-color: var(--border-color);
            cursor: col-resize;
            display: none;
            flex: none;
            z-index: 100;
            transition: background-color 0.2s;
        }
        #resizer:hover, #resizer.active { background-color: var(--blue); }
        body.view-manager #resizer { display: block; }

        #map-wrapper { position: relative; background-color: var(--bg-base); }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        
        #map-hint {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.25); 
            backdrop-filter: blur(4px);
            color: rgba(255,255,255,0.9); padding: 8px 12px;
            border-radius: 6px; font-size: 13px; font-weight: bold;
            z-index: 200; pointer-events: none; border: 1px solid rgba(255,255,255,0.15);
        }

        /* SPROUTE FLOATING BRAND FOR MAP-ONLY VIEW */
        .floating-brand {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: var(--bg-header); padding: 8px 16px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px;
            border: 1px solid var(--border-color); pointer-events: none; justify-content: space-between; min-width: 200px;
        }
        body:not(.view-map) #map-brand { display: none; }

        /* CURSORS FOR SHIFT STATE */
        #map-wrapper.shift-down .mapboxgl-canvas-container,
        #map-wrapper.shift-down .mapboxgl-canvas-container.mapboxgl-interactive,
        #map-wrapper.shift-down .mapboxgl-canvas-container.mapboxgl-interactive:active {
            cursor: crosshair !important;
        }
        #map-wrapper.shift-down .marker,
        #map-wrapper.shift-down .marker .pin-visual {
            cursor: pointer !important;
        }

        /* SUMMARY BOX */
        #route-summary { padding: 10px 12px; background: #000; color: #fff; display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: bold; }
        .summary-left { display: flex; align-items: center; gap: 12px; }

        .btn-reoptimize { 
            background: var(--blue); color: white; border: none; border-radius: 6px; 
            padding: 6px 12px; font-size: 15px; font-weight: normal; cursor: pointer; 
            display: flex; align-items: center; gap: 6px; transition: opacity 0.2s;
        }
        .btn-reoptimize:active { opacity: 0.7; }

        /* ROCKER BUTTON */
        .rocker { display: flex; background: #222; border-radius: 6px; padding: 2px; }
        .rocker div { padding: 4px 10px; cursor: pointer; border-radius: 4px; transition: 0.2s; color: var(--text-muted); font-weight: normal; font-size: 15px; }
        .rocker div.active { background: var(--blue); color: white; }

        /* FLOATING ACTION BUTTONS */
        .map-overlay-btns { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .floating-btn { background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 16px; font-weight: bold; font-size: 13px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.5); display: none; }
        #bulk-remove-btn { background: var(--red); color: white; border: none; }
        #bulk-complete-btn { background: var(--green); color: white; border: none; }

        /* SIDEBAR & CONTAINER QUERIES */
        #sidebar { 
            display: flex; flex-direction: column; background: var(--bg-panel); z-index: 10; 
            container-type: inline-size; 
            container-name: sidebar;
            overflow-x: hidden; 
        }
        
        #search-container { padding: 8px; border-bottom: 1px solid var(--border-color); background: var(--bg-panel); }
        #search-input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-base); color: var(--text-main); }
        #search-input::placeholder { color: var(--text-muted); }
        #stop-list { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; position: relative; }

        @container sidebar (max-width: 700px) { .col-type { display: none !important; } }
        @container sidebar (max-width: 600px) { .col-client { display: none !important; } }
        @container sidebar (max-width: 500px) { .col-app { display: none !important; } }
        @container sidebar (max-width: 450px) { .col-due { display: none !important; } }
        @container sidebar (max-width: 380px) { .col-insp { display: none !important; } }

        /* GLIDE STYLE BUTTONS */
        #controls { display: none; padding: 12px; background: var(--bg-base); border-bottom: 1px solid var(--border-color); flex-direction: column; gap: 8px; }
        .ctrl-row { display: flex; gap: 8px; width: 100%; }
        .btn-glide { 
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 10px; border: none; border-radius: 8px; font-weight: normal; font-size: 13px; 
            cursor: pointer; transition: opacity 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .btn-glide:active { opacity: 0.7; }

        /* TILE UI (Admin & Driver) */
        .stop-item { display: flex; align-items: stretch; border-bottom: 1px solid var(--border-color); background: var(--bg-panel); min-height: 60px; cursor: pointer; position: relative; }
        .stop-item.completed { opacity: 0.5; background: var(--bg-base); }
        .stop-item.selected { background: var(--fade-blue) !important; }
        .stop-item.compact { min-height: 45px; }
        
        .stop-sidebar { width: 35px; background-color: var(--purple); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }
        .stop-sidebar.due-today { background-color: var(--orange); }
        .stop-sidebar.past-due { background-color: var(--red); }

        .handle { padding: 0 8px; color: var(--text-muted); cursor: grab; font-size: 18px; display: flex; align-items: center; }
        .csv-box { align-self: center; width: 28px; height: 28px; border: 1.5px solid var(--blue); color: var(--blue); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; border-radius: 4px; margin: 0 8px; }
        
        .stop-content { flex: 1; padding: 5px 0; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .stop-content b { font-size: 15px; color: var(--text-main); line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .compact .row-meta, .compact .row-details { display: none; }
        .row-meta { font-size: 12px; color: var(--text-muted); }
        .row-details { font-size: 11px; color: #666; }
        
        .due-date-container { display: flex; align-items: center; padding: 0 10px; font-weight: bold; font-size: 18px; color: var(--text-main); margin-left: auto; }
        .due-date-container.due-today { color: var(--orange); }
        .due-date-container.past-due { color: var(--red); }

        .stop-actions { display: flex; align-items: center; padding-right: 8px; gap: 4px; }
        .icon-btn { font-size: 28px; cursor: pointer; padding: 4px; }

        /* GLIDE TABLE UI (List & Manager View) */
        .glide-table-header { display: flex; padding: 10px 8px; font-weight: bold; border-bottom: 1px solid var(--border-color); color: var(--text-muted); font-size: 12px; text-transform: uppercase; background: var(--bg-header); position: sticky; top: 0; z-index: 5; }
        .glide-row { display: flex; padding: 10px 8px; border-bottom: 1px solid #282828; font-size: 14px; color: var(--text-main); align-items: center; cursor: pointer; background: var(--bg-panel); transition: background 0.2s; }
        .glide-row:hover { background: var(--bg-hover); }
        .glide-row.selected { background: var(--fade-blue) !important; }
        .glide-row.completed { opacity: 0.5; }
        
        .sortable { cursor: pointer; transition: color 0.2s; display: flex; align-items: center; }
        .sortable:hover { color: var(--text-main); }
        
        .col-num { width: 36px; color: var(--text-muted); font-size: 12px; flex-shrink: 0; display: flex; align-items: center; }
        
        .num-badge { 
            width: 26px; height: 26px; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 13px;
        }
        .glide-row.completed .num-badge { background-color: #555 !important; color: white !important; }

        .col-due { width: 65px; display: flex; align-items: center; justify-content: center; gap: 2px; font-weight: 500; flex-shrink: 0;}
        .col-due.due-today { color: var(--orange); }
        .col-due.past-due { color: var(--red); font-weight: bold; }

        .col-insp { width: 120px; color: var(--text-muted); padding-right: 6px; flex-shrink: 0; }
        
        /* Adjusted widths and paddings to fit more columns */
        .col-addr { flex: 1 1 auto; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 6px; font-weight: 500; }
        .col-app { width: 45px; color: var(--text-muted); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .col-client { width: 110px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 6px; flex-shrink: 0; }
        .col-type { width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-muted); flex-shrink: 0;}

        /* Flat Dropdown Styling */
        .insp-select { 
            width: 100%; 
            background-color: var(--bg-panel); 
            color: var(--text-main); 
            border: 1px solid var(--border-color); 
            padding: 6px 20px 6px 6px; 
            border-radius: 4px; 
            font-size: 13px; 
            cursor: pointer; 
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23888888%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 10px auto;
        }
        .insp-select:focus { outline: none; border-color: var(--blue); }
        .insp-select option { background: var(--bg-panel); color: var(--text-main); }
        .insp-select:disabled { opacity: 0.6; cursor: not-allowed; }

        /* MARKERS */
        .marker { 
            position: absolute !important; 
            width: 28px; height: 28px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; 
            border-radius: 50%;
            z-index: 1;
        }
        .marker.bulk-selected { 
            z-index: 1000 !important;
        }
        
        .pin-visual {
            width: 100%; height: 100%;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; color: white;
            border: 2px solid var(--bg-panel);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .marker.bulk-selected .pin-visual { 
            background-color: #ffffff !important; 
            color: #000000 !important; 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); 
            transform: scale(1.15); 
            border-color: #ffffff !important;
        }
        .marker.completed .pin-visual { background-color: #555 !important; color: white !important; }
        
        .marker-warning { position: absolute; top: -10px; right: -10px; font-size: 16px; pointer-events: none; z-index: 5; }

        /* SELECTION BOX */
        .boxdraw {
            background: rgba(37, 99, 235, 0.3); /* Sproute Blue match */
            border: 1px solid var(--blue);
            position: absolute;
            top: 0; left: 0; width: 0; height: 0;
            pointer-events: none; 
            z-index: 999;
        }

        /* MODALS & OVERLAYS */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-panel); color: var(--text-main); padding: 20px; border-radius: 8px; width: 90%; max-width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
        .modal-box input { background: var(--bg-base); color: var(--text-main); border: 1px solid var(--border-color); }

        #processing-overlay {
            display: flex; 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; 
            color: white; font-size: 22px; font-weight: bold; letter-spacing: 1px;
        }
    </style>
</head>
<body class="view-driver">

<div id="processing-overlay">Processing...</div>

<div id="map-wrapper">
    <div id="map-brand" class="floating-brand">
        <span id="map-driver-name" style="font-size: 18px; font-weight: bold; color: var(--text-main); letter-spacing: 0.5px;"></span>
        <img id="brand-logo-map" src="https://raw.githubusercontent.com/mypieinteractive/prospect-dashboard/809b30bc160d3e353020425ce349c77544ed0452/Sproute%20Logo.png" style="height: 28px; width: auto;" alt="Brand Logo">
    </div>

    <div id="map-hint">Shift-drag or Shift-click to select multiple</div>
    <div class="map-overlay-btns">
        <button id="reset-view-btn" class="floating-btn" onclick="resetMapView()">Reset View</button>
        <button id="bulk-complete-btn" class="floating-btn" onclick="triggerBulkComplete()">Mark selected as completed</button>
        <button id="bulk-remove-btn" class="floating-btn" onclick="triggerBulkDelete()">Remove selected from route</button>
    </div>
    <div id="map"></div>
</div>

<div id="resizer"></div>

<div id="sidebar">
    <div id="sidebar-brand" style="padding: 12px 15px; background: var(--bg-header); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
        <span id="sidebar-driver-name" style="font-size: 20px; font-weight: bold; color: var(--text-main); letter-spacing: 0.5px;"></span>
        <img id="brand-logo-sidebar" src="https://raw.githubusercontent.com/mypieinteractive/prospect-dashboard/809b30bc160d3e353020425ce349c77544ed0452/Sproute%20Logo.png" style="height: 36px; width: auto;" alt="Brand Logo">
    </div>

    <div id="route-summary">
        <div class="summary-left">
            <button id="btn-reoptimize" class="btn-reoptimize" onclick="handleOptimize()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Re-Optimize
            </button>
            <div><span id="sum-dist">-- mi</span> | <span id="sum-time">-- hrs</span></div>
        </div>
        <div class="rocker">
            <div id="btn-detailed" class="active" onclick="setDisplayMode('detailed')">Detailed</div>
            <div id="btn-compact" onclick="setDisplayMode('compact')">Compact</div>
        </div>
    </div>
    <div id="search-container"><input type="text" id="search-input" placeholder="Search address or client..." onkeyup="filterList()"></div>
    
    <div id="controls">
        <div style="text-align: center; font-weight: bold; color: var(--red); font-size: 12px; margin-bottom: 4px;">CHANGES MADE - SYNC REQUIRED</div>
        <div class="ctrl-row">
            <button class="btn-glide" style="background:#444; color:white;" onclick="handleCalculate()">
                <i class="fa-solid fa-calculator"></i> Re-Calculate
            </button>
            <button class="btn-glide" style="background:var(--bg-panel); color:var(--text-main); border:1px solid var(--border-color);" onclick="handleUndo()">
                <i class="fa-solid fa-rotate-left"></i> Undo Changes
            </button>
        </div>
    </div>
    
    <div id="stop-list"></div>
</div>

<div id="modal-overlay"><div class="modal-box" id="modal-content"></div></div>

<script>
    // --- SHIFT CURSOR ENGINE ---
    function updateShiftCursor(isShiftDown) {
        const wrap = document.getElementById('map-wrapper');
        if (wrap) {
            if (isShiftDown && !wrap.classList.contains('shift-down')) {
                wrap.classList.add('shift-down');
            } else if (!isShiftDown && wrap.classList.contains('shift-down')) {
                wrap.classList.remove('shift-down');
            }
        }
    }
    document.addEventListener('keydown', (e) => { if (e.key === 'Shift') updateShiftCursor(true); });
    document.addEventListener('keyup', (e) => { if (e.key === 'Shift') updateShiftCursor(false); });
    document.addEventListener('mousemove', (e) => { updateShiftCursor(e.shiftKey); });

    const MAPBOX_TOKEN = 'pk.eyJ1IjoibXlwaWVpbnRlcmFjdGl2ZSIsImEiOiJjbWx2ajk5Z2MwOGZlM2VwcDBkc295dzI1In0.eGIhcRPrj_Hx_PeoFAYxBA';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzgh2KCzfdWbOmdVq_edpuI_m6HxkfErzYAEHySfKkq1zgLtwuiUT3GCS5Xor9GgjFa/exec';
    
    let COMPANY_SERVICE_DELAY = 1; 
    let PERMISSION_MODIFY = true;
    let PERMISSION_REOPTIMIZE = true;
    let sortableInstance = null;

    const params = new URLSearchParams(window.location.search);
    const routeId = params.get('id');
    const driverParam = params.get('driver');
    const companyParam = params.get('company');
    const viewMode = params.get('view') || 'driver'; 
    
    document.body.className = `view-${viewMode}`;

    if (viewMode === 'manager') {
        document.getElementById('bulk-remove-btn').innerText = 'Remove selected';
    }

    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({ 
        container: 'map', 
        style: 'mapbox://styles/mapbox/dark-v11', 
        center: [-96.797, 32.776], 
        zoom: 11, 
        attributionControl: false,
        boxZoom: false 
    });

    let stops = [], originalStops = [], inspectors = [], markers = [], initialBounds = null, selectedIds = new Set(), currentDisplayMode = 'detailed', currentStartTime = "8:00 AM";
    let currentSort = { col: null, asc: true };

    // --- HIGH CONTRAST CATEGORICAL PALETTE FOR INSPECTORS ---
    const INSPECTOR_PALETTE = [
        { bg: '#2563eb', text: '#ffffff' }, 
        { bg: '#10b981', text: '#ffffff' }, 
        { bg: '#f1c40f', text: '#000000' }, 
        { bg: '#9b59b6', text: '#ffffff' }, 
        { bg: '#e67e22', text: '#000000' }, 
        { bg: '#1abc9c', text: '#000000' }, 
        { bg: '#e84393', text: '#ffffff' }, 
        { bg: '#00cec9', text: '#000000' }, 
        { bg: '#bcf60c', text: '#000000' }, 
        { bg: '#3f51b5', text: '#ffffff' }  
    ];

    function getInspectorStyle(driverId) {
        if (!driverId) return { bg: 'var(--red)', text: '#ffffff' };
        const index = inspectors.findIndex(i => i.id === driverId);
        if (index === -1) return { bg: 'var(--red)', text: '#ffffff' };
        return INSPECTOR_PALETTE[index % INSPECTOR_PALETTE.length];
    }

    // --- RESIZER ENGINE ---
    const resizerEl = document.getElementById('resizer');
    const sidebarEl = document.getElementById('sidebar');
    const mapWrapEl = document.getElementById('map-wrapper');
    let isResizing = false;

    resizerEl.addEventListener('mousedown', (e) => {
        if(viewMode !== 'manager') return;
        isResizing = true;
        resizerEl.classList.add('active');
        document.body.style.cursor = 'col-resize';
        mapWrapEl.style.pointerEvents = 'none'; 
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        let newWidth = window.innerWidth - e.clientX;
        if (newWidth < 300) newWidth = 300;
        if (newWidth > window.innerWidth - 300) newWidth = window.innerWidth - 300;
        sidebarEl.style.width = newWidth + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            resizerEl.classList.remove('active');
            mapWrapEl.style.pointerEvents = 'auto';
            if(map) map.resize(); 
        }
    });

    // --- DATA FETCHING & API SYNC ---
    async function loadData() {
        let queryParams = '';
        if (companyParam) queryParams = `?company=${companyParam}`;
        else if (driverParam) queryParams = `?driver=${driverParam}`;
        else if (routeId) queryParams = `?id=${routeId}`;
        else {
            const overlay = document.getElementById('processing-overlay');
            if (overlay) overlay.style.display = 'none';
            return;
        }

        try {
            const res = await fetch(`${WEB_APP_URL}${queryParams}`);
            const data = await res.json();
            
            let rawStops = [];
            
            if (Array.isArray(data)) {
                rawStops = data; 
            } else {
                rawStops = data.stops || [];
                inspectors = data.inspectors || []; 
                if (data.serviceDelay !== undefined) {
                    COMPANY_SERVICE_DELAY = parseInt(data.serviceDelay); 
                }
                
                // Permission Assignment
                if (data.permissions) {
                    if (typeof data.permissions.modify !== 'undefined') PERMISSION_MODIFY = data.permissions.modify;
                    if (typeof data.permissions.reoptimize !== 'undefined') PERMISSION_REOPTIMIZE = data.permissions.reoptimize;
                }
                
                // Subscription Tier & Dynamic Logo Logic
                if (data.tier && data.companyLogo) {
                    if (data.tier === 'Company' || data.tier.toLowerCase() === 'company') {
                        const mapLogo = document.getElementById('brand-logo-map');
                        const sidebarLogo = document.getElementById('brand-logo-sidebar');
                        if (mapLogo) mapLogo.src = data.companyLogo;
                        if (sidebarLogo) sidebarLogo.src = data.companyLogo;
                    }
                }
                
                // Update Display Name dynamically from payload
                let displayName = data.displayName || 'Sproute'; 
                const mapDriverEl = document.getElementById('map-driver-name');
                if (mapDriverEl) mapDriverEl.innerText = displayName;
                const sidebarDriverEl = document.getElementById('sidebar-driver-name');
                if (sidebarDriverEl) sidebarDriverEl.innerText = displayName;
            }
            
            // Hide Optimization UI based on new permissions
            const optBtn = document.getElementById('btn-reoptimize');
            if (optBtn) {
                optBtn.style.display = PERMISSION_REOPTIMIZE ? 'flex' : 'none';
            }
            
            stops = rawStops.map(s => ({
                ...s,
                id: s.rowId || s.id 
            }));

            originalStops = JSON.parse(JSON.stringify(stops)); 
            if (stops.length > 0 && stops[0].eta) {
                currentStartTime = stops[0].eta;
            }
            
            if(viewMode === 'map' || viewMode === 'list' || viewMode === 'manager') {
                document.querySelector('.rocker').style.display = 'none';
            }

            render(); drawRoute(); updateSummary(); initSortable();
        } catch (e) { 
            console.error("Error loading data:", e); 
        } finally {
            const overlay = document.getElementById('processing-overlay');
            if (overlay) overlay.style.display = 'none';
        }
    }

    async function processDeleteOrder(rowId) {
        try {
            stops = stops.filter(s => s.id !== rowId);
            render(); drawRoute(); updateSummary();

            const payload = { action: 'deleteOrder', rowId: rowId };
            await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
        } catch(e) {
            console.error("Failed to delete order", e);
            alert("Network error: Failed to delete order. Please refresh.");
        }
    }

    async function processReassignDriver(rowId, newDriverName, newDriverId) {
        const stopIdx = stops.findIndex(s => s.id === rowId);
        if (stopIdx > -1) {
            stops[stopIdx].driverName = newDriverName;
            stops[stopIdx].driverId = newDriverId;
        }

        const payload = { 
            action: 'updateOrder', 
            rowId: rowId, 
            updates: { "HKAwZ": newDriverName, "xuPjx": newDriverId } 
        };
        
        return fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        });
    }

    async function handleInspectorChange(e, rowId, selectEl) {
        e.stopPropagation(); 
        const newDriverId = selectEl.value;
        const newDriverName = selectEl.options[selectEl.selectedIndex].text;
        
        let idsToUpdate = [rowId];
        
        if (selectedIds.has(rowId) && selectedIds.size > 1) {
            if (confirm(`Reassign all ${selectedIds.size} selected orders to ${newDriverName}?`)) {
                idsToUpdate = Array.from(selectedIds);
            } else {
                render();
                return;
            }
        }
        
        const overlay = document.getElementById('processing-overlay');
        if(overlay) overlay.style.display = 'flex';
        
        try {
            for (const id of idsToUpdate) {
                await processReassignDriver(id, newDriverName, newDriverId);
            }
        } catch (err) {
            console.error("Failed to reassign driver", err);
            alert("Network error: Failed to update some orders. Please refresh.");
        }
        
        render(); 
        if(overlay) overlay.style.display = 'none';
    }

    // --- SORTING ENGINE ---
    function sortTable(col) {
        if (currentSort.col === col) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.col = col;
            currentSort.asc = true;
        }

        stops.sort((a, b) => {
            let valA = a[col] || '';
            let valB = b[col] || '';
            
            if (col === 'dueDate') {
                valA = valA ? new Date(valA).getTime() : Number.MAX_SAFE_INTEGER;
                valB = valB ? new Date(valB).getTime() : Number.MAX_SAFE_INTEGER;
            } else {
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
            }

            if (valA < valB) return currentSort.asc ? -1 : 1;
            if (valA > valB) return currentSort.asc ? 1 : -1;
            return 0;
        });
        
        render(); 
    }

    function getSortIcon(col) {
        if (currentSort.col !== col) return '<i class="fa-solid fa-sort" style="opacity:0.3; margin-left:4px;"></i>';
        return currentSort.asc ? '<i class="fa-solid fa-sort-up" style="margin-left:4px; color:var(--blue);"></i>' : '<i class="fa-solid fa-sort-down" style="margin-left:4px; color:var(--blue);"></i>';
    }


    // --- RENDERING ---
    function setDisplayMode(mode) {
        currentDisplayMode = mode;
        document.getElementById('btn-detailed').classList.toggle('active', mode === 'detailed');
        document.getElementById('btn-compact').classList.toggle('active', mode === 'compact');
        render();
    }

    function render(isDraft = false) {
        const list = document.getElementById('stop-list');
        list.innerHTML = ''; 
        markers.forEach(m => m.remove()); 
        markers = [];
        const bounds = new mapboxgl.LngLatBounds();
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (viewMode === 'list' || viewMode === 'manager') {
            const header = document.createElement('div');
            header.className = 'glide-table-header';
            header.innerHTML = `
                <div class="col-num"></div>
                <div class="col-due sortable" onclick="sortTable('dueDate')">Due ${getSortIcon('dueDate')}</div>
                <div class="col-insp sortable" onclick="sortTable('driverName')">Inspector ${getSortIcon('driverName')}</div>
                <div class="col-addr sortable" onclick="sortTable('address')">Address ${getSortIcon('address')}</div>
                <div class="col-app">App</div>
                <div class="col-client sortable" onclick="sortTable('client')">Client ${getSortIcon('client')}</div>
                <div class="col-type sortable" onclick="sortTable('type')">Order type ${getSortIcon('type')}</div>
            `;
            list.appendChild(header);
        }

        stops.filter(s => s.status !== 'cancelled').forEach((s, i) => {
            const item = document.createElement('div');
            item.id = `item-${s.id}`;
            item.setAttribute('data-search', `${(s.address||'').toLowerCase()} ${(s.client||'').toLowerCase()}`);
            
            const due = s.dueDate ? new Date(s.dueDate) : null;
            let urgencyClass = '';
            
            if (due) {
                const dueTime = new Date(due);
                dueTime.setHours(0, 0, 0, 0); 
                if (dueTime < today) {
                    urgencyClass = 'past-due'; 
                } else if (dueTime.getTime() === today.getTime()) {
                    urgencyClass = 'due-today'; 
                }
            }
            
            const dueFmt = due ? `${due.getMonth()+1}/${due.getDate()}` : "N/A";

            if (viewMode === 'list' || viewMode === 'manager') {
                item.className = `glide-row ${s.status}`;
                
                let inspectorHtml = `<div class="col-insp">${s.driverName || driverParam || 'Unassigned'}</div>`;
                
                if (viewMode === 'manager' && inspectors.length > 0) {
                    const optionsHtml = inspectors.map(insp => 
                        `<option value="${insp.id}" ${s.driverId === insp.id ? 'selected' : ''}>${insp.name}</option>`
                    ).join('');
                    
                    const defaultPlaceholder = !s.driverId ? `<option value="" disabled selected hidden>Select Inspector...</option>` : '';
                    const disableSelectAttr = !PERMISSION_MODIFY ? 'disabled' : '';

                    inspectorHtml = `
                        <div class="col-insp" onclick="event.stopPropagation()">
                            <select class="insp-select" onchange="handleInspectorChange(event, '${s.id}', this)" ${disableSelectAttr}>
                                ${defaultPlaceholder}
                                ${optionsHtml}
                            </select>
                        </div>
                    `;
                }

                const inspectorStyle = getInspectorStyle(s.driverId);

                item.innerHTML = `
                    <div class="col-num"><div class="num-badge" style="background-color: ${inspectorStyle.bg}; color: ${inspectorStyle.text};">${i + 1}</div></div>
                    <div class="col-due ${urgencyClass}">${dueFmt}</div>
                    ${inspectorHtml}
                    <div class="col-addr">${(s.address||'').split(',')[0]}</div>
                    <div class="col-app">IA</div>
                    <div class="col-client">${s.client || '--'}</div>
                    <div class="col-type">${s.type || '--'}</div>
                `;
            } else {
                item.className = `stop-item ${s.status} ${currentDisplayMode}`;
                const metaDisplay = isDraft ? '-- | --' : `${s.eta || '--'} | ${s.dist || '--'}`;
                const handleHtml = PERMISSION_MODIFY ? `<div class="handle">☰</div>` : ``;
                
                item.innerHTML = `
                    <div class="stop-sidebar ${urgencyClass}">${i + 1}</div>
                    ${handleHtml}
                    <div class="csv-box">${(s.client||"??").substring(0,2).toUpperCase()}</div>
                    <div class="stop-content">
                        <b>${(s.address||'').split(',')[0]}</b>
                        <div class="row-meta">${metaDisplay}</div>
                        <div class="row-details">${s.type || ''}</div>
                    </div>
                    <div class="due-date-container ${urgencyClass}">${dueFmt}</div>
                    <div class="stop-actions">
                        <i class="fa-solid fa-circle-check icon-btn" style="color:var(--green)" onclick="toggleComplete(event, '${s.id}')"></i>
                        <i class="fa-solid fa-location-arrow icon-btn" style="color:var(--blue)" onclick="openNav(event, '${s.lat}','${s.lng}')"></i>
                    </div>
                `;
            }
            
            item.onclick = (e) => {
                if (!e.shiftKey) selectedIds.clear();
                selectedIds.has(s.id) ? selectedIds.delete(s.id) : selectedIds.add(s.id);
                updateSelectionUI(); focusPin(s.id);
            };
            list.appendChild(item);

            if(s.lng && s.lat) {
                const el = document.createElement('div');
                el.className = `marker ${s.status}`; 
                
                const style = getInspectorStyle(s.driverId);
                el.innerHTML = `<div class="pin-visual" style="background-color: ${style.bg}; color: ${style.text};"><span>${i + 1}</span></div>`;

                if (urgencyClass) {
                    const w = document.createElement('div'); w.className = 'marker-warning'; w.innerText = '⚠️';
                    el.appendChild(w);
                }
                
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!e.shiftKey) selectedIds.clear();
                    selectedIds.has(s.id) ? selectedIds.delete(s.id) : selectedIds.add(s.id);
                    updateSelectionUI(); focusTile(s.id);
                });
                
                const m = new mapboxgl.Marker({ element: el, anchor: 'center' }).setLngLat([s.lng, s.lat]).addTo(map);
                m._stopId = s.id; markers.push(m); bounds.extend([s.lng, s.lat]);
            }
        });
        if (stops.filter(s=> s.lng && s.lat).length > 0) { initialBounds = bounds; map.fitBounds(bounds, { padding: 50, maxZoom: 15 }); }
        
        updateSelectionUI();
    }

    function updateSummary() {
        const active = stops.filter(s => s.status !== 'cancelled' && s.status !== 'completed');
        let totalMi = 0;
        active.forEach(s => totalMi += parseFloat(s.dist || 0));
        document.getElementById('sum-dist').innerText = `${totalMi.toFixed(1)} mi`;
        document.getElementById('sum-time').innerText = `${Math.ceil(active.length * 0.4)} hrs`;
    }

    function formatTime(dateObj) {
        let h = dateObj.getHours();
        let m = dateObj.getMinutes();
        let ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12;
        h = h ? h : 12;
        m = m < 10 ? '0'+m : m;
        return h + ':' + m + ' ' + ampm;
    }

    // --- FRONTEND ROUTING CALCULATOR (MAPBOX API) ---
    async function handleCalculate() {
        const overlay = document.getElementById('processing-overlay');
        if (overlay) overlay.style.display = 'flex';

        try {
            const activeStops = stops.filter(s => s.status !== 'cancelled' && s.lng && s.lat);
            if (activeStops.length < 2) {
                alert("Not enough valid stops to calculate a route.");
                if (overlay) overlay.style.display = 'none';
                return;
            }

            const MAX_WAYPOINTS = 25; // Mapbox API strict limit
            let legs = []; 

            // Execute Mapbox routing in chunks, overlapping endpoints
            for (let i = 0; i < activeStops.length - 1; i += (MAX_WAYPOINTS - 1)) {
                const chunk = activeStops.slice(i, i + MAX_WAYPOINTS);
                const coords = chunk.map(s => `${s.lng},${s.lat}`).join(';');
                
                const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?access_token=${MAPBOX_TOKEN}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
                    throw new Error("Mapbox routing failed: " + data.message);
                }
                
                legs.push(...data.routes[0].legs);
            }

            // Setup Start Time base
            let time = new Date();
            let match = currentStartTime.match(/(\d+):(\d+)\s*(AM|PM)?/i);
            if (match) {
                let hours = parseInt(match[1]);
                let mins = parseInt(match[2]);
                if (match[3] && match[3].toUpperCase() === 'PM' && hours < 12) hours += 12;
                if (match[3] && match[3].toUpperCase() === 'AM' && hours === 12) hours = 0;
                time.setHours(hours, mins, 0, 0);
            } else {
                time.setHours(8, 0, 0, 0); 
            }

            let totalMeters = 0;

            // Apply cumulative math across the synchronized array
            activeStops.forEach((stop, index) => {
                if (index === 0) {
                    stop.eta = formatTime(time);
                    stop.dist = "0.0 mi";
                    stop.durationSecs = 0;
                } else {
                    let leg = legs[index - 1];
                    // Increment ETA = Current Time + Stop Delay + Drive Duration
                    time = new Date(time.getTime() + (COMPANY_SERVICE_DELAY * 60 * 1000) + (leg.duration * 1000));
                    stop.eta = formatTime(time);
                    
                    // Increment Mileage = Current Meters + Leg Distance
                    totalMeters += leg.distance;
                    stop.dist = (totalMeters * 0.000621371).toFixed(1) + " mi";
                    stop.durationSecs = leg.duration;
                }
            });

            // Send standard save request to backend to lock in the adjustments without pinging Google APIs
            if (routeId) {
                const saveRes = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveRoute',
                        routeId: routeId,
                        driver: driverParam,
                        stops: stops // Pass the complete, modified array
                    })
                });
                
                const saveData = await saveRes.json();
                if (saveData.error) console.warn("Backend save warning:", saveData.error);
            }

            document.getElementById('controls').style.display = 'none';
            originalStops = JSON.parse(JSON.stringify(stops)); 
            render(); 
            drawRoute(); 
            updateSummary();

        } catch (e) {
            console.error(e);
            alert("Calculation failed: " + e.message);
        } finally {
            if (overlay) overlay.style.display = 'none';
        }
    }

    function handleOptimize() { showSyncOptions('optimize'); }

    function handleUndo() {
        if(confirm("Discard all changes and revert to original route?")) {
            stops = JSON.parse(JSON.stringify(originalStops));
            document.getElementById('controls').style.display = 'none';
            render(); drawRoute(); updateSummary();
        }
    }

    function toggleComplete(e, id) {
        e.stopPropagation();
        const idx = stops.findIndex(s => s.id == id);
        stops[idx].status = (stops[idx].status === 'completed') ? '' : 'completed';
        render(); drawRoute(); updateSummary();
        if (stops[idx].status === 'completed') {
            const next = document.querySelector('.stop-item:not(.completed), .glide-row:not(.completed)');
            if (next) next.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // --- SELECTION ENGINE ---
    let start_pos, box_el;
    map.on('click', (e) => { if (e.originalEvent.target.classList.contains('mapboxgl-canvas')) { selectedIds.clear(); updateSelectionUI(); } });
    const canvas = map.getCanvasContainer();
    
    canvas.addEventListener('mousedown', (e) => { 
        if (e.target.closest('.mapboxgl-marker')) return; 
        if(e.shiftKey) { 
            map.dragPan.disable(); 
            start_pos = mousePos(e); 
            document.addEventListener('mousemove', onMouseMove); 
            document.addEventListener('mouseup', onMouseUp); 
        } 
    }, true);
    
    function mousePos(e) { const r = canvas.getBoundingClientRect(); return new mapboxgl.Point(e.clientX-r.left, e.clientY-r.top); }
    
    function onMouseMove(e) { 
        const curr = mousePos(e); 
        if(!box_el) { 
            box_el=document.createElement('div'); 
            box_el.className='boxdraw'; 
            canvas.appendChild(box_el); 
        } 
        const minX=Math.min(start_pos.x,curr.x), maxX=Math.max(start_pos.x,curr.x), minY=Math.min(start_pos.y,curr.y), maxY=Math.max(start_pos.y,curr.y); 
        box_el.style.left=minX+'px'; box_el.style.top=minY+'px'; box_el.style.width=(maxX-minX)+'px'; box_el.style.height=(maxY-minY)+'px'; 
    }
    
    function onMouseUp(e) { 
        document.removeEventListener('mousemove', onMouseMove); 
        document.removeEventListener('mouseup', onMouseUp); 
        if(box_el) { 
            const b=[start_pos, mousePos(e)]; 
            markers.filter(m => { 
                const pt=map.project(m.getLngLat()); 
                return pt.x>=Math.min(b[0].x,b[1].x) && pt.x<=Math.max(b[0].x,b[1].x) && pt.y>=Math.min(b[0].y,b[1].y) && pt.y<=Math.max(b[0].y,b[1].y); 
            }).forEach(m=>selectedIds.add(m._stopId)); 
            box_el.remove(); 
            box_el=null; 
            updateSelectionUI(); 
        } 
        
        map.dragPan.enable(); 
        start_pos=null; 
    }
    
    function updateSelectionUI() { 
        document.querySelectorAll('.stop-item, .glide-row').forEach(el=>el.classList.remove('selected')); 
        markers.forEach(m=>{ 
            m.getElement().classList.toggle('bulk-selected', selectedIds.has(m._stopId)); 
            if(selectedIds.has(m._stopId)) {
                const row = document.getElementById(`item-${m._stopId}`);
                if (row) row.classList.add('selected');
            } 
        }); 
        const has = selectedIds.size>0; 
        document.getElementById('bulk-remove-btn').style.display = (has && PERMISSION_MODIFY) ? 'block' : 'none'; 
        document.getElementById('bulk-complete-btn').style.display = has ? 'block' : 'none'; 
    }

    // --- SHARED UTILS ---
    function focusPin(id) { 
        const tgt = stops.find(s=>s.id==id);
        if(tgt && tgt.lng && tgt.lat) map.flyTo({ center: [tgt.lng, tgt.lat] }); 
    }
    function focusTile(id) { document.getElementById(`item-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    function resetMapView() { if (initialBounds) map.fitBounds(initialBounds, { padding: 50, maxZoom: 15 }); }
    function filterList() { const q = document.getElementById('search-input').value.toLowerCase(); document.querySelectorAll('.stop-item, .glide-row').forEach(el => el.style.display = el.getAttribute('data-search').includes(q) ? 'flex' : 'none'); }
    
    function drawRoute() { 
        if (viewMode === 'manager') {
            if (map.getSource('route')) {
                map.getSource('route').setData({ "type": "Feature", "geometry": { "type": "LineString", "coordinates": [] } });
            }
            return;
        }

        const act = stops.filter(s => s.status !== 'cancelled' && s.lng && s.lat); 
        if (act.length < 2) return; 
        const crd = act.map(s => [s.lng, s.lat]); 
        
        if (map.getSource('route')) {
            map.getSource('route').setData({ "type": "Feature", "geometry": { "type": "LineString", "coordinates": crd } }); 
        } else { 
            map.addSource('route', { "type": "geojson", "data": { "type": "Feature", "geometry": { "type": "LineString", "coordinates": crd } } }); 
            map.addLayer({ "id": "route", "type": "line", "source": "route", "layout": { "line-join": "round", "line-cap": "round" }, "paint": { "line-color": "#2563eb", "line-width": 4, "line-opacity": 0.5 } }); 
        } 
    }

    function openNav(e, la, ln) { e.stopPropagation(); let p = localStorage.getItem('navPref'); if (!p) { showNavChoice(la, ln); } else { launchMaps(p, la, ln); } }
    function showNavChoice(la, ln) { const m = document.getElementById('modal-overlay'); m.style.display = 'flex'; document.getElementById('modal-content').innerHTML = `<h3>Maps Preference:</h3><div style="display:flex; flex-direction:column; gap:8px;"><button style="padding:12px; border:none; border-radius:6px; background:var(--blue); color:white; font-weight:bold;" onclick="setNavPref('google','${la}','${ln}')">Google Maps</button><button style="padding:12px; border:none; border-radius:6px; background:#444; color:#fff" onclick="setNavPref('apple','${la}','${ln}')">Apple Maps</button></div>`; }
    function setNavPref(p, la, ln) { localStorage.setItem('navPref', p); document.getElementById('modal-overlay').style.display = 'none'; launchMaps(p, la, ln); }
    function launchMaps(p, la, ln) { window.location.href = p === 'google' ? `comgooglemaps://?daddr=${la},${ln}` : `maps://maps.apple.com/?daddr=${la},${ln}`; }
    
    async function triggerBulkDelete() { 
        if(confirm("Remove selected?")) { 
            const overlay = document.getElementById('processing-overlay');
            if(overlay) overlay.style.display = 'flex';

            const deletePromises = Array.from(selectedIds).map(id => processDeleteOrder(id));
            await Promise.all(deletePromises);
            
            selectedIds.clear(); 
            updateSelectionUI(); 
            document.getElementById('controls').style.display = 'flex'; 

            setTimeout(() => {
                if(overlay) overlay.style.display = 'none';
            }, 3000);
        } 
    }
    
    function triggerBulkComplete() { 
        if(confirm("Mark completed?")) { 
            selectedIds.forEach(id => { stops.find(s => s.id == id).status = 'completed'; }); 
            selectedIds.clear(); render(); drawRoute(); updateSelectionUI(); 
            document.getElementById('controls').style.display = 'flex'; 
        } 
    }

    function showSyncOptions(type) {
        const modal = document.getElementById('modal-overlay'); modal.style.display = 'flex';
        const defS = stops.length ? stops[0].address : "", defE = stops.length ? stops[stops.length-1].address : "";
        document.getElementById('modal-content').innerHTML = `
            <h3 style="margin:0">Update Locations</h3>
            <p style="font-size:12px; color:var(--text-muted);">Start Time: ${currentStartTime}</p>
            <input type="text" id="start-addr" value="${defS}" placeholder="Start Address" style="width:100%; padding:8px; margin:5px 0; border-radius:4px;">
            <input type="text" id="end-addr" value="${defE}" placeholder="End Address" style="width:100%; padding:8px; margin:5px 0; border-radius:4px;">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button style="flex:1; padding:10px; border:none; border-radius:6px; background:#444; color:#fff;" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button>
                <button style="flex:1; padding:10px; border:none; border-radius:6px; background:var(--blue); color:white; font-weight:bold;" onclick="finalizeSync('${type}')">Submit</button>
            </div>`;
    }

    async function finalizeSync(type) {
        const startAddr = document.getElementById('start-addr').value, endAddr = document.getElementById('end-addr').value;
        document.getElementById('modal-overlay').style.display = 'none';
        try {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: type, driver: driverParam, stops, startTime: currentStartTime, startAddr, endAddr }) });
            const data = await res.json(); stops = data.updatedStops;
            document.getElementById('controls').style.display = 'none'; render(); drawRoute(); updateSummary();
        } catch (e) { alert("Sync Failed."); }
    }

    function initSortable() {
        if (PERMISSION_MODIFY && viewMode !== 'list' && viewMode !== 'manager') {
            if (!sortableInstance) {
                sortableInstance = Sortable.create(document.getElementById('stop-list'), {
                    handle: '.handle', animation: 150,
                    onEnd: (evt) => {
                        const moved = stops.splice(evt.oldIndex, 1)[0];
                        stops.splice(evt.newIndex, 0, moved);
                        document.getElementById('controls').style.display = 'flex';
                        render(true); 
                    }
                });
            }
        }
    }

    loadData();
</script>
</body>
</html>
